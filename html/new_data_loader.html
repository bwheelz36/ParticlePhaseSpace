<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Writing a new data loader &mdash; Particle Phase Space  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/nbsphinx-code-cells.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Reading IAEA phase space" href="IAEA.html" />
    <link rel="prev" title="Basic Example" href="basic_example.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Particle Phase Space
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="basic_example.html">Basic Example</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Writing a new data loader</a></li>
<li class="toctree-l2"><a class="reference internal" href="IAEA.html">Reading IAEA phase space</a></li>
<li class="toctree-l2"><a class="reference internal" href="new_data_exporter.html">Writing a new data exporter</a></li>
<li class="toctree-l2"><a class="reference internal" href="transform.html">Transformation of phase space data</a></li>
<li class="toctree-l2"><a class="reference internal" href="units.html">Working with different units</a></li>
<li class="toctree-l2"><a class="reference internal" href="grid_merge.html">Compress phase space via regrid/merge operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="resampling_via_gaussian_kde.html">Up/Down sampling phase space data using gaussian KDE</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="phase_space_format.html">Phase Space Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="supported_particles.html">Supported particles</a></li>
<li class="toctree-l1"><a class="reference internal" href="limitations.html">Limitations</a></li>
<li class="toctree-l1"><a class="reference internal" href="code_docs.html">Code Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Particle Phase Space</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="examples.html">Examples</a></li>
      <li class="breadcrumb-item active">Writing a new data loader</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/new_data_loader.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Writing-a-new-data-loader">
<h1>Writing a new data loader<a class="headerlink" href="#Writing-a-new-data-loader" title="Permalink to this heading">ÔÉÅ</a></h1>
<p>One of the goals of this library is to make it easy to import/export data to and from different simulation codes. This example demonstrates how you would write a new data loader to read in data. DataLoaders must inhereit from the <code class="docutils literal notranslate"><span class="pre">ParticlePhaseSpace.DataLoaders._DataImportersBase</span></code> class. They must in addition provide two methods:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">_check_input_data</span></code>: In this method you should check that whatever data the user has supplied is what your DataLoader is expecting. For example: is it a file? Is the extension correct? etc. Basically this is a pre-check for some basic error handling.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">__import_data</span></code>: this is where the data actually gets imported. The fundamental goal of this method is to populate the data frame attribute stored at DataLoader.data such that it contains the <a href="#id1"><span class="problematic" id="id2">`required columns &lt;&gt;`__</span></a>. If it does this succesfully, then it is guaranteed that the data can now be loaded into a PhaseSpace instance.</p></li>
</ol>
<p>For the purposes of demonstration, I am going to develop a new DataLoader which reads in some data I received from a colleague. This data is ASCII encoded (i.e. text file) and contains the following columns:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>x (mm)  y (mm)  z (mm)  px (MeV/c)  py (MeV/c)  pz (MeV/c)  E (MeV)
</pre></div>
</div>
<p>Note that this data already contains all the columns we need, and with the correct units, so reading it in should be pretty straight forward. Note also that this format does not include the type of particle. This means that users will have to specify particle type using the <code class="docutils literal notranslate"><span class="pre">particle_type=</span></code> input. The basic format of any new data loader looks like this:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;../&#39;</span><span class="p">)</span>  <span class="c1"># not required if library is installed</span>
<span class="kn">from</span> <span class="nn">ParticlePhaseSpace.DataLoaders</span> <span class="kn">import</span> <span class="n">_DataLoadersBase</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">ParticlePhaseSpace.__particle_config__</span> <span class="k">as</span> <span class="nn">particle_cfg</span>

<span class="k">class</span> <span class="nc">NewDataLoader</span><span class="p">(</span><span class="n">_DataLoadersBase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_import_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_check_input_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>
</div>
</div>
<p>Now, our job is to fill in these two methods. Note that both of these will be called automatically; in addition the data entered by the user will be available at <code class="docutils literal notranslate"><span class="pre">self._input_data</span></code>. Below is an example of the complete data loader:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">NewDataLoader</span><span class="p">(</span><span class="n">_DataLoadersBase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_import_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_data</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]]</span>  <span class="o">=</span> <span class="n">Data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]]</span>  <span class="o">=</span> <span class="n">Data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]]</span>  <span class="o">=</span> <span class="n">Data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="s1">&#39;px&#39;</span><span class="p">]]</span>  <span class="o">=</span> <span class="n">Data</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="s1">&#39;py&#39;</span><span class="p">]]</span>  <span class="o">=</span> <span class="n">Data</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="s1">&#39;pz&#39;</span><span class="p">]]</span>  <span class="o">=</span> <span class="n">Data</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="s1">&#39;particle type&#39;</span><span class="p">]]</span><span class="o">=</span> <span class="n">particle_cfg</span><span class="o">.</span><span class="n">particle_properties</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_particle_type</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="c1"># we also need to fill in weight, particle id, and time; since none of these are specified we just use all</span>
        <span class="c1"># ones for weight, 1,2,3... for particle id, and all zeros for time:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">Data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="s1">&#39;particle id&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]]</span>  <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># may want to replace with time feature if available?</span>

        <span class="c1"># because we have momentum and energy, we can double check that our momentum to energy conversion is</span>
        <span class="c1"># consisten with the values in the phase space:</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_energy_consistency</span><span class="p">(</span><span class="n">Ek</span><span class="o">=</span><span class="n">E</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_input_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># is the input a file?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_data</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;input data file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_import_data</span><span class="p">()</span><span class="si">}</span><span class="s1"> does not exist&#39;</span><span class="p">)</span>
        <span class="c1"># does it have the right extension?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_data</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s1">&#39;.dat&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;This data loaders requires a *.dat file&#39;</span><span class="p">)</span>
        <span class="c1"># the header is on the first line; does it look correct?</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_data</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">first_line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">first_line</span> <span class="o">==</span> <span class="s1">&#39;x (mm)</span><span class="se">\t</span><span class="s1">y (mm)</span><span class="se">\t</span><span class="s1">z (mm)</span><span class="se">\t</span><span class="s1">px (MeV/c)</span><span class="se">\t</span><span class="s1">py (MeV/c)</span><span class="se">\t</span><span class="s1">pz (MeV/c)</span><span class="se">\t</span><span class="s1">E (MeV)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;file header does not look correct&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_particle_type</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;this data loader requires particle_type to be specified&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>OK, now lets check out if this works:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ParticlePhaseSpace._ParticlePhaseSpace</span> <span class="kn">import</span> <span class="n">PhaseSpace</span>

<span class="n">data_loc</span>  <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;../tests/test_data/new_data_loader_demo.dat&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">NewDataLoader</span><span class="p">(</span><span class="n">data_loc</span><span class="p">,</span> <span class="n">particle_type</span><span class="o">=</span><span class="s1">&#39;electrons&#39;</span><span class="p">)</span>

<span class="n">PS</span> <span class="o">=</span> <span class="n">PhaseSpace</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">PS</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">particle_positions_scatter_2D</span><span class="p">(</span><span class="n">weight_position_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">beam_direction</span><span class="o">=</span><span class="s1">&#39;z&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
generating weighted scatter plot...can be slow...
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/new_data_loader_5_1.png" src="_images/new_data_loader_5_1.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="basic_example.html" class="btn btn-neutral float-left" title="Basic Example" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="IAEA.html" class="btn btn-neutral float-right" title="Reading IAEA phase space" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Brendan Whelan.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>