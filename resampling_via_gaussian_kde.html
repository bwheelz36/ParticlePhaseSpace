<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Up/Down sampling phase space data using gaussian KDE &mdash; Particle Phase Space  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Phase Space Format" href="phase_space_format.html" />
    <link rel="prev" title="Working with different units" href="units.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Particle Phase Space
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="basic_example.html">Basic Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="new_data_loader.html">Writing a new data loader</a></li>
<li class="toctree-l2"><a class="reference internal" href="new_data_exporter.html">Writing a new data exporter</a></li>
<li class="toctree-l2"><a class="reference internal" href="units.html">Working with different units</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Up/Down sampling phase space data using gaussian KDE</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Example:-Downsampling-a-large-phase-space">Example: Downsampling a large phase space</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Clean-input-data">Clean input data</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Ad-hoc-data-cleaning-steps">Ad-hoc data cleaning steps</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Reflect-Pz">Reflect Pz</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Remove-high-divergence-particles">Remove high divergence particles</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Compare-original-to-downsampled:">Compare original to downsampled:</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Energy">Energy</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Momentum">Momentum</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Particle-Positions">Particle Positions</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="phase_space_format.html">Phase Space Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="supported_particles.html">Supported particles</a></li>
<li class="toctree-l1"><a class="reference internal" href="code_docs.html">Code Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Particle Phase Space</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="examples.html">Examples</a></li>
      <li class="breadcrumb-item active">Up/Down sampling phase space data using gaussian KDE</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/resampling_via_gaussian_kde.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars and line breaks on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
    white-space: pre;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="Up/Down-sampling-phase-space-data-using-gaussian-KDE">
<h1>Up/Down sampling phase space data using gaussian KDE<a class="headerlink" href="#Up/Down-sampling-phase-space-data-using-gaussian-KDE" title="Permalink to this heading"></a></h1>
<p>Sometimes, phase space data is very large - much larger than it actually needs to be to serve our purposes.</p>
<p>Othertimes, phase data is too small. For example, for good quality Monte Carlo simulations, a lot of independant primary particles are required - but simulating such particles is an expensive task, so you generally do not wish to simulate more particles than are required to represent the space.</p>
<p>This tutorial demonstrate how we can solve these issues using <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.gaussian_kde.html">gaussian kernel density estimates</a>.</p>
<p>Before we go any further: <strong>a warning!</strong> These approaches are fairly heuristic, and there is no guarantee they will be valid for your data. You should undertake a very careful comparison of the input and output data if you intend to utilise this approach.</p>
<section id="Example:-Downsampling-a-large-phase-space">
<h2>Example: Downsampling a large phase space<a class="headerlink" href="#Example:-Downsampling-a-large-phase-space" title="Permalink to this heading"></a></h2>
<p>Let’s load in some data:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;../&#39;</span><span class="p">)</span>  <span class="c1"># not necessary when the library is installed</span>
<span class="kn">from</span> <span class="nn">ParticlePhaseSpace</span> <span class="kn">import</span> <span class="n">DataLoaders</span>
<span class="kn">from</span> <span class="nn">ParticlePhaseSpace</span> <span class="kn">import</span> <span class="n">PhaseSpace</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">test_data_loc</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;../tests/test_data/coll_PhaseSpace_xAng_0.00_yAng_0.00_angular_error_0.0.phsp&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
<span class="n">ps_data</span> <span class="o">=</span> <span class="n">DataLoaders</span><span class="o">.</span><span class="n">Load_TopasData</span><span class="p">(</span><span class="n">test_data_loc</span><span class="p">)</span>
<span class="n">PS</span> <span class="o">=</span> <span class="n">PhaseSpace</span><span class="p">(</span><span class="n">ps_data</span><span class="p">)</span>

<span class="n">PS</span> <span class="o">=</span> <span class="n">PS</span><span class="p">(</span><span class="s1">&#39;gammas&#39;</span><span class="p">)</span>  <span class="c1"># take only the gammas for this example</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;data has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">PS</span><span class="p">)</span><span class="si">}</span><span class="s1"> particles&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
data has 308280 particles
</pre></div></div>
</div>
<p>This is a pretty dense set of particles, and for the purpose of this tutorial I will argue that I don’t actually need all these particles to represent my phase space properly (this is probably not really the case in actuality).</p>
<p>Of course, we could just downsample this phase space using the <code class="docutils literal notranslate"><span class="pre">get_downsampled_phase_space</span></code> method; this would generate a new phase space by randomly sampling the current one. However, there is no guarantee that such an approach will preserve the distributions of your input data. A more sophisticated approach is fit some function to the phase space, and then sample from this function to generate new data. This is a challening problem, because we have seven dimensions we care about (we do not
handle time in this approach):</p>
<p><code class="docutils literal notranslate"><span class="pre">x,</span> <span class="pre">y,</span> <span class="pre">z,</span> <span class="pre">px,</span> <span class="pre">py,</span> <span class="pre">pz,</span> <span class="pre">weight</span></code></p>
<p>We cannot assume that any of these quantities are independant: we have to assume correlations exist between all 7. A popular choice for such problems is <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.gaussian_kde.html">gaussian kernel density estimates</a>.</p>
<section id="Clean-input-data">
<h3>Clean input data<a class="headerlink" href="#Clean-input-data" title="Permalink to this heading"></a></h3>
<p>In general, the KDE fit appears to be quite sensitive to ‘tails’ in data. Since phase space data is often prone to having long tails in e.g. energy or position, and since we often don’t actually care about those tails anyway, it can be a good idea to manually remove them. Since I know from <a class="reference external" href="https://bwheelz36.github.io/ParticlePhaseSpace/basic_example.html#Basic-analytics">previous analysis</a> that nearly all data lies between -2&lt;=x,y&lt;=2, I am going to remove the particles outside this range:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">filter_input_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">if</span> <span class="n">filter_input_data</span><span class="p">:</span>
    <span class="n">spatial_cutoff</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">keep_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">PS</span><span class="o">.</span><span class="n">ps_data</span><span class="p">[</span><span class="s1">&#39;x [mm]&#39;</span><span class="p">])</span><span class="o">&lt;</span><span class="n">spatial_cutoff</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">PS</span><span class="o">.</span><span class="n">ps_data</span><span class="p">[</span><span class="s1">&#39;y [mm]&#39;</span><span class="p">])</span><span class="o">&lt;</span><span class="n">spatial_cutoff</span><span class="p">)</span>
    <span class="n">PS</span><span class="p">,</span> <span class="n">PS_discard</span> <span class="o">=</span> <span class="n">PS</span><span class="o">.</span><span class="n">filter_by_boolean_index</span><span class="p">(</span><span class="n">keep_ind</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
data where boolean_index=True accounts for  86.0 % of the original data
</pre></div></div>
</div>
<p>Note that we use <code class="docutils literal notranslate"><span class="pre">filter_by_boolean_index(split=True)</span></code> to split this PhaseSpace into two objects. In principle, we could model the <code class="docutils literal notranslate"><span class="pre">PS_discard</span></code> object with it’s own KDE, but as the name implies: I am just going to discard it!</p>
<p>Now we have cleaned the input a little, we can generate the KDE based phase space:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_PS</span> <span class="o">=</span> <span class="n">PS</span><span class="o">.</span><span class="n">resample_via_gaussian_kde</span><span class="p">(</span><span class="n">n_new_particles_factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">interpolate_weights</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;original data has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">PS</span><span class="p">)</span><span class="si">}</span><span class="s1"> entries, new data has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">new_PS</span><span class="p">)</span><span class="si">}</span><span class="s1"> entries&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
original data has 265149 entries, new data has 132574 entries
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/brendan/python/ParticlePhaseSpace/examples/../ParticlePhaseSpace/_ParticlePhaseSpace.py:1286: UserWarning: This method is quite experimental and should be used with extreme caution;always manually compare the new PhaseSpace data to the old PhaseSpace data to ensure it is close enough for your requirements
  warnings.warn(&#39;This method is quite experimental and should be used with extreme caution;&#39;
</pre></div></div>
</div>
</section>
</section>
<section id="Ad-hoc-data-cleaning-steps">
<h2>Ad-hoc data cleaning steps<a class="headerlink" href="#Ad-hoc-data-cleaning-steps" title="Permalink to this heading"></a></h2>
<p>The below steps are implemented in an ad hoc way to improve the kde fit. You can turn them off to see what happens when they aren’t implemented! Such ad-hoc steps are hard to implement in a general fashion, so we leave it to individual users to apply these to their own case.</p>
<section id="Reflect-Pz">
<h3>Reflect Pz<a class="headerlink" href="#Reflect-Pz" title="Permalink to this heading"></a></h3>
<p>First, let’s compare the momentums:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PS</span><span class="o">.</span><span class="n">plot_momentum_hist_1D</span><span class="p">()</span>
<span class="n">new_PS</span><span class="o">.</span><span class="n">plot_momentum_hist_1D</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/resampling_via_gaussian_kde_8_0.png" src="_images/resampling_via_gaussian_kde_8_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/resampling_via_gaussian_kde_8_1.png" src="_images/resampling_via_gaussian_kde_8_1.png" />
</div>
</div>
<p>You can see that in the original data, all values of pz are negative, but in the KDE generated data, the momentums are positive. This is a <a class="reference external" href="https://medium.com/mlearning-ai/density-estimation-for-bounded-variables-7d68f633e772">general problem with KDE</a>; to solve it, we have two options:</p>
<ol class="arabic simple">
<li><p>remove all particles with pz&gt;0 - the issue is that (a) this is a big chunk of our partilces, and (b) doing so would fundamentally change the energy histogram, which - although i haven’t shown this - actually matches quite well.</p></li>
<li><p>Reflect the positive values into negative</p></li>
</ol>
<p>I am going to take the second approach:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reflect_pz</span> <span class="o">=</span><span class="kc">True</span>
<span class="k">if</span> <span class="n">reflect_pz</span><span class="p">:</span>
    <span class="n">new_PS</span><span class="o">.</span><span class="n">ps_data</span><span class="p">[</span><span class="s1">&#39;pz [MeV/c]&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">new_PS</span><span class="o">.</span><span class="n">ps_data</span><span class="p">[</span><span class="s1">&#39;pz [MeV/c]&#39;</span><span class="p">])</span>
    <span class="n">new_PS</span><span class="o">.</span><span class="n">reset_phase_space</span><span class="p">()</span>
<span class="n">new_PS</span><span class="o">.</span><span class="n">plot_momentum_hist_1D</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/resampling_via_gaussian_kde_10_0.png" src="_images/resampling_via_gaussian_kde_10_0.png" />
</div>
</div>
<p>Ok, momentum looks much closer now! Note that I used the <code class="docutils literal notranslate"><span class="pre">reset_phase_space</span></code> method, <a class="reference external" href="https://bwheelz36.github.io/ParticlePhaseSpace/basic_example.html#Manipulating-data-in-the-phase-space">as is recomended</a> whenever we interact directly with the phase space data like this.</p>
</section>
<section id="Remove-high-divergence-particles">
<h3>Remove high divergence particles<a class="headerlink" href="#Remove-high-divergence-particles" title="Permalink to this heading"></a></h3>
<p>Let’s take a look at the beam divergences:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PS</span><span class="o">.</span><span class="n">plot_transverse_trace_space_hist_2D</span><span class="p">()</span>
<span class="n">new_PS</span><span class="o">.</span><span class="n">plot_transverse_trace_space_hist_2D</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/resampling_via_gaussian_kde_12_0.png" src="_images/resampling_via_gaussian_kde_12_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/resampling_via_gaussian_kde_12_1.png" src="_images/resampling_via_gaussian_kde_12_1.png" />
</div>
</div>
<p>This is a bit of a disaster; these plots look completely different. However, it actually appears that there are only a few outlier particles causing the second plot to look so different. We could just try removing these particles:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># remove particles that have higher divergence than the maximum divergence in the original data:</span>
<span class="n">remove_high_divergence_particles</span><span class="o">=</span><span class="kc">True</span>
<span class="k">if</span> <span class="n">remove_high_divergence_particles</span><span class="p">:</span>
    <span class="n">div_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">new_PS</span><span class="o">.</span><span class="n">ps_data</span><span class="p">[</span><span class="s1">&#39;px [MeV/c]&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">new_PS</span><span class="o">.</span><span class="n">ps_data</span><span class="p">[</span><span class="s1">&#39;pz [MeV/c]&#39;</span><span class="p">])</span>
    <span class="n">div_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">new_PS</span><span class="o">.</span><span class="n">ps_data</span><span class="p">[</span><span class="s1">&#39;py [MeV/c]&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">new_PS</span><span class="o">.</span><span class="n">ps_data</span><span class="p">[</span><span class="s1">&#39;pz [MeV/c]&#39;</span><span class="p">])</span>
    <span class="n">max_div_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">PS</span><span class="o">.</span><span class="n">ps_data</span><span class="p">[</span><span class="s1">&#39;px [MeV/c]&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">PS</span><span class="o">.</span><span class="n">ps_data</span><span class="p">[</span><span class="s1">&#39;pz [MeV/c]&#39;</span><span class="p">]))</span>
    <span class="n">max_div_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">PS</span><span class="o">.</span><span class="n">ps_data</span><span class="p">[</span><span class="s1">&#39;py [MeV/c]&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">PS</span><span class="o">.</span><span class="n">ps_data</span><span class="p">[</span><span class="s1">&#39;pz [MeV/c]&#39;</span><span class="p">]))</span>
    <span class="n">rem_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">div_x</span> <span class="o">&gt;</span> <span class="n">max_div_x</span><span class="p">,</span> <span class="n">div_y</span> <span class="o">&gt;</span> <span class="n">max_div_y</span><span class="p">)</span>
    <span class="n">new_PS</span><span class="o">.</span><span class="n">filter_by_boolean_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">rem_ind</span><span class="p">),</span> <span class="n">in_place</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">new_PS</span><span class="o">.</span><span class="n">reset_phase_space</span><span class="p">()</span>
<span class="n">new_PS</span><span class="o">.</span><span class="n">plot_transverse_trace_space_hist_2D</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
removed  0.7 % of particles
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/resampling_via_gaussian_kde_14_1.png" src="_images/resampling_via_gaussian_kde_14_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PS</span><span class="o">.</span><span class="n">print_twiss_parameters</span><span class="p">()</span>
<span class="n">new_PS</span><span class="o">.</span><span class="n">print_twiss_parameters</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
===================================================
                 TWISS PARAMETERS
===================================================

gammas:
                x         y
epsilon  0.089075  0.089526
alpha    0.568640  0.563796
beta     6.168591  6.133908
gamma    0.214531  0.214849
===================================================
                 TWISS PARAMETERS
===================================================

gammas:
                x         y
epsilon  0.201866  0.178720
alpha    0.267062  0.277615
beta     2.992315  3.371044
gamma    0.358025  0.319506
</pre></div></div>
</div>
<p>The emittance still doesn’t match perfectly, but it’s not terrible anymore either… by removing just a few outlier particles, we manged to get a phase space which looks much closer to the original!</p>
<p>Now that we have cleaned up the data, let’s compare the original data to the downsampled data:</p>
</section>
</section>
<section id="Compare-original-to-downsampled:">
<h2>Compare original to downsampled:<a class="headerlink" href="#Compare-original-to-downsampled:" title="Permalink to this heading"></a></h2>
<section id="Energy">
<h3>Energy<a class="headerlink" href="#Energy" title="Permalink to this heading"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PS</span><span class="o">.</span><span class="n">plot_energy_hist_1D</span><span class="p">()</span>
<span class="n">new_PS</span><span class="o">.</span><span class="n">plot_energy_hist_1D</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/resampling_via_gaussian_kde_18_0.png" src="_images/resampling_via_gaussian_kde_18_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/resampling_via_gaussian_kde_18_1.png" src="_images/resampling_via_gaussian_kde_18_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PS</span><span class="o">.</span><span class="n">print_energy_stats</span><span class="p">()</span>
<span class="n">new_PS</span><span class="o">.</span><span class="n">print_energy_stats</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
===================================================
                 ENERGY STATS
===================================================
total number of particles in phase space:  265149
number of unique particle species:  1
     265149 gammas
        mean energy:  2.00 MeV
        median energy:  1.23 MeV
        Energy spread IQR:  2.18 MeV
        min energy  0.01 MeV
        max energy  10.35 MeV
===================================================
                 ENERGY STATS
===================================================
total number of particles in phase space:  131593
number of unique particle species:  1
     131593 gammas
        mean energy:  2.12 MeV
        median energy:  1.41 MeV
        Energy spread IQR:  2.23 MeV
        min energy  0.00 MeV
        max energy  12.09 MeV
</pre></div></div>
</div>
</section>
</section>
<section id="Momentum">
<h2>Momentum<a class="headerlink" href="#Momentum" title="Permalink to this heading"></a></h2>
<p>although we already compared momentum, this may have changed since we filtered out high divergence particles. let’s check:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PS</span><span class="o">.</span><span class="n">plot_momentum_hist_1D</span><span class="p">()</span>
<span class="n">new_PS</span><span class="o">.</span><span class="n">plot_momentum_hist_1D</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/resampling_via_gaussian_kde_21_0.png" src="_images/resampling_via_gaussian_kde_21_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/resampling_via_gaussian_kde_21_1.png" src="_images/resampling_via_gaussian_kde_21_1.png" />
</div>
</div>
<p>Looking pretty good!</p>
<section id="Particle-Positions">
<h3>Particle Positions<a class="headerlink" href="#Particle-Positions" title="Permalink to this heading"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PS</span><span class="o">.</span><span class="n">plot_position_hist_1D</span><span class="p">()</span>
<span class="n">new_PS</span><span class="o">.</span><span class="n">plot_position_hist_1D</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/resampling_via_gaussian_kde_23_0.png" src="_images/resampling_via_gaussian_kde_23_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/resampling_via_gaussian_kde_23_1.png" src="_images/resampling_via_gaussian_kde_23_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PS</span><span class="o">.</span><span class="n">plot_particle_positions_hist_2D</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
<span class="n">new_PS</span><span class="o">.</span><span class="n">plot_particle_positions_hist_2D</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/resampling_via_gaussian_kde_24_0.png" src="_images/resampling_via_gaussian_kde_24_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/resampling_via_gaussian_kde_24_1.png" src="_images/resampling_via_gaussian_kde_24_1.png" />
</div>
</div>
<p>Again, this is a reasonable looking guess - although as an excercise, see what happens if you set <code class="docutils literal notranslate"><span class="pre">filter_input_data=False</span></code> above! This will cause this estimate to fail quite badly.</p>
<p>As you can see, it is possible using this approach to get a reasonable match to your input data This allows you to both upsample and downsample a phase space. Of course, as I mentioned above:</p>
<ol class="arabic simple">
<li><p>be careful!</p></li>
<li><p>consider what the accuracy requirements are for your specfic application!</p></li>
</ol>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="units.html" class="btn btn-neutral float-left" title="Working with different units" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="phase_space_format.html" class="btn btn-neutral float-right" title="Phase Space Format" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Brendan Whelan.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>